<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 프로필 - 정원사들 시즌10</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .profile-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #3498db;
            margin-right: 30px;
        }

        .profile-info {
            flex: 1;
        }

        .profile-username {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .github-link {
            display: inline-flex;
            align-items: center;
            color: #0366d6;
            text-decoration: none;
        }

        .github-link:hover {
            text-decoration: underline;
        }

        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 16px;
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #586069;
        }

        .section-container {
            margin-bottom: 30px;
        }
        
        .section-container h3 {
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e4e8;
            color: #24292e;
        }

        .commit-list {
            margin-top: 20px;
        }

        .commit {
            background-color: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .commit-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .commit-repository {
            font-weight: bold;
            color: #0366d6;
        }
        
        .private-commit {
            background-color: #fafbfc;
            border-left: 3px solid #f6b26b;
        }
        
        .private-label {
            display: inline-block;
            background-color: #f6b26b;
            color: #fff;
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 12px;
            margin-left: 6px;
            vertical-align: middle;
        }

        .commit-date {
            color: #586069;
            font-size: 0.9em;
        }

        .commit-message {
            padding: 8px 0;
            white-space: pre-line;
        }

        .commit-id {
            font-family: monospace;
            font-size: 0.9em;
            color: #586069;
        }

        .commit-url {
            display: inline-block;
            margin-top: 8px;
            color: #0366d6;
            text-decoration: none;
        }

        .commit-url:hover {
            text-decoration: underline;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            background-color: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 8px 16px;
            margin: 0 5px;
            cursor: pointer;
        }

        .pagination button:hover {
            background-color: #e1e4e8;
        }

        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .no-items {
            text-align: center;
            padding: 20px;
            color: #586069;
        }
        
        /* 커밋 히트맵 스타일 */
        .commits-heatmap-wrapper {
            padding: 20px 0;
            overflow-x: auto;
            max-width: 100%;
        }
        
        .commits-heatmap {
            display: grid;
            grid-template-rows: repeat(7, 15px); /* 7일(일~토) */
            grid-template-columns: 30px repeat(53, 15px); /* 요일 레이블 + 최대 53주 */
            gap: 3px;
            margin-bottom: 10px;
        }
        
        .month-labels {
            display: grid;
            grid-template-columns: 30px repeat(53, 15px); /* 빈 셀 + 최대 53주 */
            gap: 3px;
            height: 20px;
            margin-bottom: 5px;
        }
        
        .month-label {
            font-size: 12px;
            color: #586069;
            text-align: center;
            white-space: nowrap;
            overflow: visible;
            min-width: 30px;
        }
        
        .heatmap-cell {
            width: 15px;
            height: 15px;
            border-radius: 2px;
            background-color: #ebedf0;
        }
        
        .day-label {
            font-size: 12px;
            color: #586069;
            text-align: right;
            padding-right: 5px;
            height: 15px;
            line-height: 15px;
        }
        
        .level-0 { background-color: #ebedf0; }
        .level-1 { background-color: #9be9a8; }
        .level-2 { background-color: #40c463; }
        .level-3 { background-color: #30a14e; }
        .level-4 { background-color: #216e39; }
        .heatmap-cell.selected { border: 2px solid #0366d6; }

        .tooltip {
            position: absolute;
            background-color: #24292e;
            color: #ffffff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .commits-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-top: 5px;
            font-size: 12px;
            color: #586069;
        }
        
        .commits-legend span {
            margin-right: 5px;
        }
        
        .legend-item {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin: 0 2px;
        }
    </style>
</head>
<body>
    <!-- GNB 영역 -->
    <header class="gnb">
        <h1>정원사들 시즌10</h1>
        <div class="header-buttons">
            <a href="/" class="back-button">메인으로 돌아가기</a>
            <div id="auth-container">
                <!-- 로그인 상태에 따라 동적으로 변경됨 -->
                <button id="login-btn" class="login-button">GitHub 로그인</button>
                <div id="user-profile" class="user-profile hidden">
                    <img id="user-avatar" class="user-avatar" src="" alt="프로필 이미지">
                    <span id="user-name"></span>
                    <button id="logout-btn" class="logout-button">로그아웃</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main 영역 -->
    <main>
        <section class="user-profile-container">
            <!-- 프로필 헤더 -->
            <div class="profile-header">
                <img id="profile-image" class="profile-image" src="" alt="프로필 이미지">
                <div class="profile-info">
                    <h2 id="profile-username" class="profile-username"></h2>
                    <a id="github-link" class="github-link" href="" target="_blank">
                        GitHub 프로필 보기
                    </a>
                </div>
            </div>
            
            <!-- 통계 정보 -->
            <div class="stats-container">
                <div class="stat-card">
                    <div id="total-commits" class="stat-value">-</div>
                    <div class="stat-label">총 커밋 수</div>
                </div>
                <div class="stat-card">
                    <div id="total-repos" class="stat-value">-</div>
                    <div class="stat-label">저장소 수</div>
                </div>
                <div class="stat-card">
                    <div id="last-commit" class="stat-value">-</div>
                    <div class="stat-label">최근 커밋</div>
                </div>
            </div>
            
            <!-- 커밋 그래프 영역 -->
            <div class="section-container">
                <h3>커밋 히트맵</h3>
                <div id="commits-heatmap-loading" class="loading">커밋 데이터 로딩 중...</div>
                <div id="commits-heatmap-container" class="hidden">
                    <div id="commits-heatmap"></div>
                    <div id="date-filter-info" class="hidden" style="margin-top: 10px; display: flex; align-items: center; justify-content: flex-end;">
                        <span id="filtered-date-text" style="margin-right: 10px;"></span>
                        <button id="reset-date-filter" class="small-button" style="padding: 3px 8px; font-size: 12px; border-radius: 4px; background-color: #f6f8fa; border: 1px solid #e1e4e8; cursor: pointer;">전체 보기</button>
                    </div>
                </div>
            </div>
            
            <!-- 커밋 내역 -->
            <div class="section-container">
                <h3>커밋 내역</h3>
                <div id="commits-loading" class="loading">커밋 내역을 불러오는 중...</div>
                <div id="no-commits" class="no-items hidden">커밋 내역이 없습니다.</div>
                
                <div id="commits-container" class="commit-list hidden">
                    <!-- 커밋 내역이 동적으로 추가됨 -->
                </div>
                
                <div id="commits-pagination" class="pagination">
                    <button id="commits-prev-page" disabled>이전</button>
                    <span id="commits-page-info">1 / 1</span>
                    <button id="commits-next-page" disabled>다음</button>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // URL에서 사용자 ID 가져오기
            const pathSegments = window.location.pathname.split('/');
            const githubId = pathSegments[pathSegments.length - 1];
            
            if (!githubId) {
                showError('사용자 ID가 지정되지 않았습니다.');
                return;
            }
            
            // 사용자 정보 가져오기
            loadUserProfile(githubId);
            
            // 커밋 내역 가져오기
            loadCommits(githubId, 1);
            
            // 커밋 히트맵 데이터 가져오기
            loadCommitsHeatmap(githubId);
            
            // 인증 상태 확인
            checkAuthStatus();
            
            // 로그인/로그아웃 버튼 이벤트 리스너
            document.getElementById('login-btn').addEventListener('click', function() {
                window.location.href = '/api/auth/login';
            });
            
            document.getElementById('logout-btn').addEventListener('click', function() {
                window.location.href = '/api/auth/logout';
            });
            
            // 페이지네이션 이벤트 리스너
            document.getElementById('commits-prev-page').addEventListener('click', function() {
                const currentPage = parseInt(document.getElementById('commits-page-info').textContent.split(' / ')[0]);
                if (currentPage > 1) {
                    // 저장된 날짜 필터 사용
                    const filter = window.currentDateFilter || {};
                    const selectedCell = document.querySelector('.heatmap-cell.selected');
                    
                    // 선택된 날짜가 있으면 loadCommitsForDate 사용, 아니면 loadCommits 사용
                    if (selectedCell) {
                        loadCommitsForDate(githubId, currentPage - 1, filter.fromDate);
                    } else {
                        loadCommits(githubId, currentPage - 1, filter.fromDate, filter.toDate);
                    }
                }
            });
            
            document.getElementById('commits-next-page').addEventListener('click', function() {
                const pageInfo = document.getElementById('commits-page-info').textContent.split(' / ');
                const currentPage = parseInt(pageInfo[0]);
                const totalPages = parseInt(pageInfo[1]);
                
                if (currentPage < totalPages) {
                    // 저장된 날짜 필터 사용
                    const filter = window.currentDateFilter || {};
                    const selectedCell = document.querySelector('.heatmap-cell.selected');
                    
                    // 선택된 날짜가 있으면 loadCommitsForDate 사용, 아니면 loadCommits 사용
                    if (selectedCell) {
                        loadCommitsForDate(githubId, currentPage + 1, filter.fromDate);
                    } else {
                        loadCommits(githubId, currentPage + 1, filter.fromDate, filter.toDate);
                    }
                }
            });
            
            // "전체 보기" 버튼 클릭 이벤트
            document.getElementById('reset-date-filter').addEventListener('click', function() {
                // 선택된 셀이 있다면 선택 해제
                const selectedCell = document.querySelector('.heatmap-cell.selected');
                if (selectedCell) {
                    selectedCell.classList.remove('selected');
                }
                
                // 날짜 필터 정보 숨기기
                document.getElementById('date-filter-info').classList.add('hidden');
                
                // 기존 커밋 내역 초기화
                document.getElementById('commits-container').innerHTML = '';
                // 리셋
                document.getElementById('commits-prev-page').disabled = true;
                document.getElementById('commits-next-page').disabled = true;
                document.getElementById('commits-page-info').textContent = '1 / 1';
                
                // 전체 커밋 내역 다시 로드 (전체 통계 유지)
                loadCommits(githubId, 1);
            });
        });
        
        // 사용자 프로필 로드
        function loadUserProfile(githubId) {
            fetch(`/api/users/github/${githubId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('사용자를 찾을 수 없습니다.');
                    }
                    return response.json();
                })
                .then(user => {
                    // 프로필 정보 설정
                    document.getElementById('profile-username').textContent = user.github_id;
                    document.getElementById('profile-image').src = user.github_profile_url;
                    document.getElementById('github-link').href = `https://github.com/${user.github_id}`;
                    
                    // 페이지 제목 설정
                    document.title = `${user.github_id} - 정원사들 시즌10`;
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('사용자 정보를 불러오는 중 오류가 발생했습니다.');
                });
        }
        
        // 커밋 히트맵 로드 및 표시
        function loadCommitsHeatmap(githubId) {
            // 로딩 표시
            document.getElementById('commits-heatmap-loading').classList.remove('hidden');
            document.getElementById('commits-heatmap-container').classList.add('hidden');
            
            // 일별 커밋 수 가져오기
            fetch(`/api/github-commits/${githubId}/daily-counts`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('서버 오류');
                    }
                    return response.json();
                })
                .then(data => {
                    // 로딩 숨기기
                    document.getElementById('commits-heatmap-loading').classList.add('hidden');
                    document.getElementById('commits-heatmap-container').classList.remove('hidden');
                    
                    // 데이터 파싱 및 히트맵 생성
                    createCommitsHeatmap(data.daily_commits, data.from_date, data.to_date);
                })
                .catch(error => {
                    console.error('Error loading commits heatmap:', error);
                    document.getElementById('commits-heatmap-loading').classList.add('hidden');
                    document.getElementById('commits-heatmap-loading').textContent = '커밋 데이터를 불러오는 중 오류가 발생했습니다.';
                });
        }
        
        // 커밋 히트맵 생성
        function createCommitsHeatmap(dailyCommits, fromDate, toDate) {
            // URL에서 사용자 ID 가져오기
            const pathSegments = window.location.pathname.split('/');
            const githubId = pathSegments[pathSegments.length - 1];
            
            const heatmapContainer = document.getElementById('commits-heatmap');
            heatmapContainer.innerHTML = '';
            
            // 툴팁 생성
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            document.body.appendChild(tooltip);
            
            // 히트맵 래퍼 생성
            const heatmapWrapper = document.createElement('div');
            heatmapWrapper.className = 'commits-heatmap-wrapper';
            
            // 월 레이블 배열
            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            
            // 시작과 종료 날짜 설정
            let startDate = new Date(fromDate);
            const endDate = new Date(toDate);
            
            // 첫 주의 일요일로 startDate 조정
            const startDay = startDate.getDay();
            if (startDay !== 0) {
                startDate.setDate(startDate.getDate() - startDay);
            }
            
            // 주 수 계산
            const totalDays = Math.round((endDate - startDate) / (24 * 60 * 60 * 1000));
            const weeksCount = Math.ceil(totalDays / 7);
            
            // 월 레이블 컨테이너 생성
            const monthLabelsContainer = document.createElement('div');
            monthLabelsContainer.className = 'month-labels';
            
            // 첫 빈 셀 추가
            const emptyMonthCell = document.createElement('div');
            monthLabelsContainer.appendChild(emptyMonthCell);
            
            // 월 레이블 생성 - 짧은 이름 배열 사용
            const shortMonthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            let currentMonth = -1;
            let monthStartWeek = 0;
            
            for (let week = 0; week < weeksCount; week++) {
                const weekDate = new Date(startDate);
                weekDate.setDate(startDate.getDate() + (week * 7));
                
                const month = weekDate.getMonth();
                if (month !== currentMonth) {
                    if (currentMonth !== -1) {
                        // 이전 월 레이블 추가
                        const monthLabel = document.createElement('div');
                        monthLabel.className = 'month-label';
                        monthLabel.textContent = shortMonthNames[currentMonth];
                        
                        // 레이블 위치 조정 - 최소 3칸 이상 확보
                        const colspan = week - monthStartWeek;
                        
                        if (colspan >= 3) {
                            monthLabel.style.gridColumnStart = (monthStartWeek + 2).toString();
                            monthLabel.style.gridColumnEnd = (week + 2).toString();
                        } else {
                            // 너무 좁으면 첫 주 위치에만 표시
                            monthLabel.style.gridColumnStart = (monthStartWeek + 2).toString();
                            monthLabel.style.gridColumnEnd = (monthStartWeek + 3).toString();
                        }
                        
                        monthLabelsContainer.appendChild(monthLabel);
                    }
                    
                    currentMonth = month;
                    monthStartWeek = week;
                }
            }
            
            // 마지막 월 레이블 추가
            if (currentMonth !== -1) {
                const monthLabel = document.createElement('div');
                monthLabel.className = 'month-label';
                monthLabel.textContent = shortMonthNames[currentMonth];
                
                // 최소 3칸 이상 확보
                const colspan = weeksCount - monthStartWeek;
                
                if (colspan >= 3) {
                    monthLabel.style.gridColumnStart = (monthStartWeek + 2).toString();
                    monthLabel.style.gridColumnEnd = (weeksCount + 2).toString();
                } else {
                    // 너무 좁으면 첫 주 위치에만 표시
                    monthLabel.style.gridColumnStart = (monthStartWeek + 2).toString();
                    monthLabel.style.gridColumnEnd = (monthStartWeek + 3).toString();
                }
                
                monthLabelsContainer.appendChild(monthLabel);
            }
            
            // 히트맵 그리드 생성
            const heatmapGrid = document.createElement('div');
            heatmapGrid.className = 'commits-heatmap';
            
            // 요일 레이블 추가 (일-토)
            const dayLabels = ['일', '월', '화', '수', '목', '금', '토'];
            for (let i = 0; i < 7; i++) {
                const dayLabel = document.createElement('div');
                dayLabel.className = 'day-label';
                dayLabel.textContent = i % 2 === 0 ? dayLabels[i] : '';  // 간격을 두고 요일 표시
                dayLabel.style.gridRow = (i + 1).toString();
                dayLabel.style.gridColumn = "1";
                heatmapGrid.appendChild(dayLabel);
            }
            
            // 날짜 셀 생성 - 요일별로 행, 주별로 열 생성
            for (let week = 0; week < weeksCount; week++) {  // 열: 각 주 (최대 53주)
                for (let day = 0; day < 7; day++) {  // 행: 각 요일 (0=일요일, 1=월요일, ...)
                    const date = new Date(startDate);
                    // 각 요일에 맞는 날짜 계산
                    date.setDate(startDate.getDate() + (week * 7) + day);
                    
                    // 날짜 범위를 확인하여 적절히 처리
                    if (date < new Date(fromDate)) {
                        // 시작일 이전은 빈 셀로 처리
                        const emptyCell = document.createElement('div');
                        emptyCell.className = 'heatmap-cell';
                        emptyCell.style.visibility = 'hidden';
                        emptyCell.style.gridRow = (day + 1).toString();
                        emptyCell.style.gridColumn = (week + 2).toString();
                        heatmapGrid.appendChild(emptyCell);
                        continue;
                    } else if (date > endDate) {
                        // 종료일 이후는 표시하지 않음
                        const emptyCell = document.createElement('div');
                        emptyCell.className = 'heatmap-cell';
                        emptyCell.style.visibility = 'hidden';
                        emptyCell.style.gridRow = (day + 1).toString();
                        emptyCell.style.gridColumn = (week + 2).toString();
                        heatmapGrid.appendChild(emptyCell);
                        continue;
                    }
                    
                    const dateStr = date.toISOString().split('T')[0];
                    const commitCount = dailyCommits[dateStr] || 0;
                    
                    // 커밋 수에 따른 레벨 결정 (0-4)
                    let level = 0;
                    if (commitCount > 0) {
                        if (commitCount >= 10) level = 4;
                        else if (commitCount >= 5) level = 3;
                        else if (commitCount >= 3) level = 2;
                        else level = 1;
                    }
                    
                    const cell = document.createElement('div');
                    cell.className = `heatmap-cell level-${level}`;
                    cell.dataset.date = dateStr;
                    cell.dataset.count = commitCount;
                    
                    // 그리드 위치 지정
                    cell.style.gridRow = (day + 1).toString();
                    cell.style.gridColumn = (week + 2).toString();
                    
                    // 툴팁 이벤트
                    cell.addEventListener('mouseover', function(e) {
                        const date = new Date(this.dataset.date);
                        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                        const formattedDate = date.toLocaleDateString('ko-KR', options);
                        const count = this.dataset.count;
                        
                        tooltip.textContent = `${formattedDate}: ${count}개의 커밋`;
                        tooltip.style.opacity = '1';
                        tooltip.style.left = `${e.pageX + 10}px`;
                        tooltip.style.top = `${e.pageY + 10}px`;
                    });
                    
                    cell.addEventListener('mousemove', function(e) {
                        tooltip.style.left = `${e.pageX + 10}px`;
                        tooltip.style.top = `${e.pageY + 10}px`;
                    });
                    
                    cell.addEventListener('mouseout', function() {
                        tooltip.style.opacity = '0';
                    });
                    
                    // 날짜 셀 클릭 이벤트 - 해당 날짜의 커밋 내역만 표시
                    cell.addEventListener('click', function() {
                        const dateStr = this.dataset.date;
                        const count = this.dataset.count;
                        
                        // 이전에 선택된 셀이 있다면 하이라이트 제거
                        const prevSelected = document.querySelector('.heatmap-cell.selected');
                        if (prevSelected) {
                            prevSelected.classList.remove('selected');
                        }
                        
                        // 현재 셀에 하이라이트 추가
                        this.classList.add('selected');
                        
                        // 날짜 필터 정보 표시
                        const dateFilterInfo = document.getElementById('date-filter-info');
                        document.getElementById('filtered-date-text').textContent = 
                            `${dateStr} (${count}개의 커밋)`;
                        dateFilterInfo.classList.remove('hidden');
                        
                        // 해당 날짜의 커밋 불러오기
                        console.log('클릭한 날짜:', dateStr);
                        // 기존 커밋 내역 초기화
                        document.getElementById('commits-container').innerHTML = '';
                        // 리셋
                        document.getElementById('commits-prev-page').disabled = true;
                        document.getElementById('commits-next-page').disabled = true;
                        document.getElementById('commits-page-info').textContent = '1 / 1';
                        
                        // 해당 날짜의 커밋만 로드 (통계는 전체 유지)
                        loadCommitsForDate(githubId, 1, dateStr);
                    });
                    
                    heatmapGrid.appendChild(cell);
                }
            }
            
            // 범례 추가
            const legend = document.createElement('div');
            legend.className = 'commits-legend';
            legend.innerHTML = `
                <span>적음</span>
                <div class="legend-item level-0"></div>
                <div class="legend-item level-1"></div>
                <div class="legend-item level-2"></div>
                <div class="legend-item level-3"></div>
                <div class="legend-item level-4"></div>
                <span>많음</span>
            `;
            
            // 히트맵 구성 요소 추가
            heatmapWrapper.appendChild(monthLabelsContainer);
            heatmapWrapper.appendChild(heatmapGrid);
            heatmapWrapper.appendChild(legend);
            heatmapContainer.appendChild(heatmapWrapper);
        }
        
        // 커밋 내역 로드
        // 기존 커밋 로드 함수 - 통계도 함께 업데이트함
        function loadCommits(githubId, page, fromDate = null, toDate = null) {
            const limit = 10;
            const skip = (page - 1) * limit;
            
            // 쿼리 파라미터 구성
            let queryParams = `skip=${skip}&limit=${limit}`;
            if (fromDate) {
                queryParams += `&from_date=${fromDate}`;
                console.log('시작 날짜 파라미터:', fromDate);
            }
            if (toDate) {
                queryParams += `&to_date=${toDate}`;
                console.log('종료 날짜 파라미터:', toDate);
            }
            
            // 현재 사용 중인 날짜 필터를 전역 변수로 저장
            window.currentDateFilter = {
                fromDate: fromDate,
                toDate: toDate
            };
            
            console.log('API 요청 URL:', `/api/github-commits/${githubId}?${queryParams}`);
            
            // 로딩 표시
            document.getElementById('commits-loading').classList.remove('hidden');
            document.getElementById('commits-container').classList.add('hidden');
            document.getElementById('no-commits').classList.add('hidden');
            
            // 먼저 커밋 통계 정보 가져오기 (총 커밋 수 정보 등)
            loadCommitStats(githubId, fromDate, toDate);
            
            // 커밋 내역 가져오기
            fetch(`/api/github-commits/${githubId}?${queryParams}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('서버 오류');
                    }
                    return response.json();
                })
                .then(data => {
                    // 로딩 숨기기
                    document.getElementById('commits-loading').classList.add('hidden');
                    
                    const commits = data.commits;
                    const pagination = data.pagination;
                    
                    // 결과가 없는 경우
                    if (commits.length === 0 && page === 1) {
                        document.getElementById('no-commits').classList.remove('hidden');
                        document.getElementById('commits-pagination').classList.add('hidden');
                        return;
                    }
                    
                    // 커밋 내역 표시
                    displayCommits(commits);
                    
                    // API에서 제공한 페이지네이션 정보로 업데이트
                    updateCommitsPagination(
                        pagination.page, 
                        pagination.total, 
                        pagination.limit, 
                        pagination.pages
                    );
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('commits-loading').classList.add('hidden');
                    document.getElementById('no-commits').classList.remove('hidden');
                    document.getElementById('no-commits').textContent = '커밋 내역을 불러오는 중 오류가 발생했습니다.';
                });
        }
        
        // 날짜 필터용 커밋 로드 함수 - 통계는 업데이트하지 않음
        function loadCommitsForDate(githubId, page, dateStr) {
            const limit = 10;
            const skip = (page - 1) * limit;
            
            // 쿼리 파라미터 구성 (날짜는 시작과 종료 모두 동일하게 설정)
            let queryParams = `skip=${skip}&limit=${limit}&from_date=${dateStr}&to_date=${dateStr}`;
            
            // 현재 사용 중인 날짜 필터를 전역 변수로 저장
            window.currentDateFilter = {
                fromDate: dateStr,
                toDate: dateStr
            };
            
            console.log('히트맵 날짜 필터 API 요청 URL:', `/api/github-commits/${githubId}?${queryParams}`);
            
            // 로딩 표시
            document.getElementById('commits-loading').classList.remove('hidden');
            document.getElementById('commits-container').classList.add('hidden');
            document.getElementById('no-commits').classList.add('hidden');
            
            // 커밋 내역만 가져오기 (통계는 업데이트하지 않음)
            fetch(`/api/github-commits/${githubId}?${queryParams}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('서버 오류');
                    }
                    return response.json();
                })
                .then(data => {
                    // 로딩 숨기기
                    document.getElementById('commits-loading').classList.add('hidden');
                    
                    const commits = data.commits;
                    const pagination = data.pagination;
                    
                    // 결과가 없는 경우
                    if (commits.length === 0 && page === 1) {
                        document.getElementById('no-commits').classList.remove('hidden');
                        document.getElementById('commits-pagination').classList.add('hidden');
                        return;
                    }
                    
                    // 커밋 내역 표시
                    displayCommits(commits);
                    
                    // API에서 제공한 페이지네이션 정보로 업데이트
                    updateCommitsPagination(
                        pagination.page, 
                        pagination.total, 
                        pagination.limit, 
                        pagination.pages
                    );
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('commits-loading').classList.add('hidden');
                    document.getElementById('no-commits').classList.remove('hidden');
                    document.getElementById('no-commits').textContent = '커밋 내역을 불러오는 중 오류가 발생했습니다.';
                });
        }
        
        // 커밋 통계 정보 로드
        function loadCommitStats(githubId, fromDate = null, toDate = null) {
            // 쿼리 파라미터 구성
            let queryParams = '';
            if (fromDate) {
                queryParams += `from_date=${fromDate}&`;
            }
            if (toDate) {
                queryParams += `to_date=${toDate}`;
            }
            
            // 마지막 & 제거
            if (queryParams.endsWith('&')) {
                queryParams = queryParams.slice(0, -1);
            }
            
            const url = `/api/github-commits/${githubId}/stats${queryParams ? '?' + queryParams : ''}`;
            console.log('통계 API URL:', url);
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('서버 오류');
                    }
                    return response.json();
                })
                .then(stats => {
                    // 총 커밋 수 업데이트
                    document.getElementById('total-commits').textContent = stats.total_commits;
                    
                    // 저장소 수 업데이트
                    document.getElementById('total-repos').textContent = stats.total_repos;
                    
                    // 통계 기간 정보 표시 (선택적)
                    if (stats.from_date && stats.to_date) {
                        const fromDate = new Date(stats.from_date);
                        const toDate = new Date(stats.to_date);
                        
                        const options = { month: '2-digit', day: '2-digit' };
                        const periodText = `${fromDate.toLocaleDateString('ko-KR', options)} ~ ${toDate.toLocaleDateString('ko-KR', options)} 기간`;
                        
                        // 여기에 기간 정보를 표시할 수 있음 (선택적)
                        // document.getElementById('commit-period').textContent = periodText;
                    }
                    
                    // 최근 커밋 날짜 업데이트
                    if (stats.latest_commit_date) {
                        // 타임존 차이를 고려하여 날짜 표시
                        let lastCommitText;
                        if (stats.days_since_last_commit === 0) {
                            lastCommitText = '오늘';
                        } else if (stats.days_since_last_commit === 1) {
                            lastCommitText = '어제';
                        } else {
                            lastCommitText = `${stats.days_since_last_commit}일 전`;
                        }
                        
                        document.getElementById('last-commit').textContent = lastCommitText;
                    } else {
                        document.getElementById('last-commit').textContent = '-';
                    }
                })
                .catch(error => {
                    console.error('Error loading commit stats:', error);
                    // 오류 발생 시 기본값 표시
                    document.getElementById('total-commits').textContent = '-';
                    document.getElementById('total-repos').textContent = '-';
                    document.getElementById('last-commit').textContent = '-';
                });
        }
        
        // 커밋 내역 표시
        function displayCommits(commits) {
            const container = document.getElementById('commits-container');
            container.innerHTML = '';
            
            commits.forEach(commit => {
                const commitDate = new Date(commit.commit_date);
                // UTC 시간을 한국 시간으로 변환 (KST = UTC+9)
                const options = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'Asia/Seoul'
                };
                const formattedDate = commitDate.toLocaleString('ko-KR', options);
                
                // private 레포지토리 여부에 따른 클래스 추가
                const privateClass = commit.is_private ? 'private-commit' : '';
                
                const commitElement = document.createElement('div');
                commitElement.className = `commit ${privateClass}`;
                
                // private 레포지토리인 경우 표시
                const privateLabel = commit.is_private 
                    ? '<span class="private-label">비공개</span>' 
                    : '';
                
                commitElement.innerHTML = `
                    <div class="commit-header">
                        <span class="commit-repository">${commit.repository} ${privateLabel}</span>
                        <span class="commit-date">${formattedDate}</span>
                    </div>
                    <div class="commit-message">${commit.message}</div>
                    <div class="commit-id">${commit.commit_id.substring(0, 7)}</div>
                    <a href="${commit.commit_url}" target="_blank" class="commit-url">GitHub에서 보기</a>
                `;
                
                container.appendChild(commitElement);
            });
            
            container.classList.remove('hidden');
        }
        
        // 커밋 페이지네이션 업데이트
        function updateCommitsPagination(currentPage, totalItems, limit, totalPages) {
            // totalPages가 제공되지 않은 경우 계산
            totalPages = totalPages || Math.ceil(totalItems / limit) || 1;
            
            document.getElementById('commits-page-info').textContent = `${currentPage} / ${totalPages}`;
            
            document.getElementById('commits-prev-page').disabled = currentPage <= 1;
            document.getElementById('commits-next-page').disabled = currentPage >= totalPages;
            
            // 페이지네이션 버튼 표시
            if (totalPages > 1) {
                document.getElementById('commits-pagination').classList.remove('hidden');
            } else {
                document.getElementById('commits-pagination').classList.add('hidden');
            }
        }
        
        // 인증 상태 확인
        function checkAuthStatus() {
            fetch('/api/auth/me')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('인증 실패');
                    }
                    return response.json();
                })
                .then(userData => {
                    // 로그인 성공 상태
                    document.getElementById('login-btn').classList.add('hidden');
                    const userProfile = document.getElementById('user-profile');
                    userProfile.classList.remove('hidden');
                    
                    // 사용자 정보 표시
                    document.getElementById('user-avatar').src = userData.github_profile_url;
                    document.getElementById('user-name').textContent = userData.github_id;
                })
                .catch(error => {
                    // 로그인 안된 상태
                    document.getElementById('login-btn').classList.remove('hidden');
                    document.getElementById('user-profile').classList.add('hidden');
                });
        }
        
        // 오류 표시
        function showError(message) {
            alert(message);
        }
    </script>
</body>
</html>